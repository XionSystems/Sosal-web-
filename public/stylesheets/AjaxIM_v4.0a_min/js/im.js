/*
 *Copyright (c) 2005 - 2010 Joshua Gross [MIT Licensed]
 */
(function($,_instance){AjaxIM=function(options,actions){if(this instanceof AjaxIM){var self=this;var defaults={pollType:"long",pollServer:"./ajaxim.php",cookieName:"ajaxim_session",theme:"themes/default",storageMethod:"auto",flashStorage:"js/jStore.Flash.html",storeSession:5,checkResume:true};this.settings=$.extend(defaults,options);this.actions=$.extend({login:this.settings.pollServer+"/login",logout:this.settings.pollServer+"/logout",register:this.settings.pollServer+"/register",poll:this.settings.pollServer+"/poll?method="+this.settings.pollType,send:this.settings.pollServer+"/send",status:this.settings.pollServer+"/status",resume:this.settings.pollServer+"/resume"},actions);var httpRx=new RegExp("^http://","i"),slashslashRx=new RegExp("^//","i"),queryStrRx=new RegExp("[?](.+)$"),subdomainRx=new RegExp("((http[s]?:)?//)?(.+?)[.]"+window.location.host,"i");$.each(this.actions,function(name,action){if(name=="poll"){if(self.settings.pollType!="comet"){action+=(queryStrRx.test(action[1])?"&":"?")+"callback=?"}action=["jsonp",action]}else{action=["ajax",action];if(subdomainRx.test(action[1])){document.domain="."+window.location.host}else{if((http=httpRx.test(action[1]))||slashslashRx.test(action[1])){if(!(new RegExp("//"+window.location.host+"/","i")).test(action[1])){action[1]+=(queryStrRx.test(action[1])?"&":"?")+"callback=?";action=["jsonp",action[1]]}}}}self.actions[name]=action});this.themeLoaded=false;if(this.settings.theme){$("<div></div>").appendTo("body").load(this.settings.theme+"/theme.html #imjs-bar, .imjs-tooltip",function(){self.themeLoaded=true;setup.apply(self)});if(typeof document.createStyleSheet=="function"){document.createStyleSheet(this.settings.theme+"/theme.css")}else{$("body").append('<link rel="stylesheet" href="'+this.settings.theme+'/theme.css" />')}}else{this.themeLoaded=true;setup.apply(this)}if(this.settings.storageMethod){this.storageBrowserKey="unknown";this.storeKey="";$.each($.browser,function(k,v){if(k=="version"){return true}else{if(v==true){self.storageBrowserKey=k;return false}}});if(this.settings.storageMethod=="auto"){$.each(["ie","html5","local","flash"],function(){if($.jStore.Availability[this]()){self.settings.storageMethod=this;return false}})}$.extend($.jStore.defaults,{project:"im.js",engine:this.settings.storageMethod,flash:this.settings.flashStorage});this.storageReady=false;if(this.settings.storageMethod=="flash"){$.jStore.ready(function(engine){$.jStore.flashReady(function(){self.storageReady=true;setup.apply(self)})})}else{$.jStore.ready(function(engine){self.storageReady=true;setup.apply(self)})}$.jStore.load()}else{this.storageReady=true;setup.apply(this)}$(".imjs-chatbox").live("click",function(e){e.preventDefault();return false});$(".imjs-chatbox .imjs-minimize").live("click",function(){$(this).parents(".imjs-chatbox").data("tab").click()});$(".imjs-chatbox .imjs-close").live("click",function(){var chatbox=$(this).parents(".imjs-chatbox");chatbox.data("tab").data("state","closed").css("display","none");if(self.settings.storageMethod&&self.storageReady){delete self.chatstore[chatbox.data("username")];if(self.storageReady){$.jStore.store(self.storageBrowserKey+"-"+self.username+"-chats",self.chatstore)}}});$(".imjs-chatbox .imjs-input").live("keydown",function(event){var obj=$(this);if(event.keyCode==13&&!($.browser.msie&&$.browser.version<8)){self.send(obj.parents(".imjs-chatbox").data("username"),obj.val())}}).live("keyup",function(event){if(event.keyCode==13){if($.browser.msie&&$.browser.version<8){var obj=$(this);self.send(obj.parents(".imjs-chatbox").data("username"),obj.val())}var obj=$(this);obj.val("");obj.height(obj.data("height"))}}).live("keypress",function(e){var obj=$(this);if(!($.browser.msie&&$.browser.opera)){obj.height(0)}if(this.scrollHeight>obj.height()||this.scrollHeight<obj.height()){obj.height(this.scrollHeight)}});$(".imjs-msglog").live("click",function(){var chatbox=$(this).parents(".imjs-chatbox");chatbox.find(".imjs-input").focus()});$(".imjs-friend").live("click",function(){var chatbox=self._createChatbox($(this).data("friend"));if(chatbox.data("tab").data("state")!="active"){chatbox.data("tab").click()}chatbox.find(".imjs-input").focus()});$(".imjs-scroll").css("display","none");$("#imjs-scroll-left").live("click",function(){var hiddenTab=$("#imjs-bar li.imjs-tab:visible").slice(-1).next("#imjs-bar li.imjs-tab:hidden").filter(function(){return $(this).data("state")!="closed"}).not(".imjs-default").slice(-1).css("display","");if(hiddenTab.length){$("#imjs-bar li.imjs-tab:visible").eq(0).css("display","none");$(this).html(parseInt($(this).html())-1);$("#imjs-scroll-right").html(parseInt($("#imjs-scroll-right").html())+1)}return false});$("#imjs-scroll-right").live("click",function(){var hiddenTab=$("#imjs-bar li.imjs-tab:visible").eq(0).prev("#imjs-bar li.imjs-tab:hidden").filter(function(){return $(this).data("state")!="closed"}).not(".imjs-default").slice(-1).css("display","");if(hiddenTab.length){$("#imjs-bar li.imjs-tab:visible").slice(-1).css("display","none");$(this).html(parseInt($(this).html())-1);$("#imjs-scroll-left").html(parseInt($("#imjs-scroll-left").html())+1)}return false});this.chats={};this.resume();$(window).resize(function(){self.bar._scrollers()})}else{return AjaxIM.init(options)}};var prequeue=[];var empty=function(){var func=this;return function(){prequeue.push([func,arguments])}};$.extend(AjaxIM.prototype,{settings:{},friends:{},chats:{},storage:empty.apply("storage"),login:empty.apply("login"),logout:empty.apply("logout"),resume:empty.apply("resume"),form:empty.apply("form"),poll:empty.apply("poll"),incoming:empty.apply("incoming"),send:empty.apply("send"),status:empty.apply("status"),statuses:{},bar:{initialize:empty.apply("bar.initialize"),activateTab:empty.apply("bar.activateTab"),closeTab:empty.apply("bar.closeTab"),addTab:empty.apply("bar.addTab"),notification:empty.apply("bar.notification"),_scrollers:empty.apply("bar._scrollers")}});setup=(function(){var self=this;if(!this.storageReady||!this.themeLoaded){return}$(self).trigger("loadComplete");$(window).resize();$.extend(AjaxIM.prototype,{cookies:{set:function(name,value,days){if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));var expires="; expires="+date.toGMTString()}else{var expires=""}document.cookie=name+"="+$.compactJSON(value)+expires+"; path=/"},get:function(name){var nameEQ=name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" "){c=c.substring(1,c.length)}if(c.indexOf(nameEQ)==0){var cval=decodeURIComponent(c.substring(nameEQ.length,c.length));return $.secureEvalJSON(cval)}}return null},erase:function(name){self.cookies.set(name,"",-1)}},storage:function(){if(!self.storeKey.length){return}try{var chatstore=$.jStore.store(self.storeKey+"chats")||{}}catch(e){$.jStore.remove(self.storeKey+"chats");var chatstore={}}if(this.chatstore){$.each(this.chatstore,function(username,convo){if(username in chatstore){chatstore[username]=$.merge(chatstore[username],self.chatstore[username])}else{chatstore[username]=self.chatstore[username]}});this.chatstore=chatstore;$.jStore.store(self.storeKey+"chats",chatstore)}else{this.chatstore=chatstore}$.each(this.chatstore,function(username,convo){if(!convo.length){return}var chatbox=self._createChatbox(username,true);chatbox.data("lastDateStamp",null).css("display","none");chatbox.find(".imjs-msglog").empty();$.each(convo,function(){switch(this[0]){case"error":self._addError(chatbox,decodeURIComponent(this[2]),this[3]);break;case"datestamp":self._addDateStamp(chatbox,this[3]);break;case"a":case"b":self._addMessage(this[0],chatbox,this[1],decodeURIComponent(this[2]),this[3]);break}});$(self).trigger("chatRestored",[username,chatbox])});var activeTab=$.jStore.store(self.storeKey+"activeTab")||[];if(activeTab.length&&(activeTab=activeTab[0])&&activeTab in this.chats){this.chats[activeTab].data("tab").click();var msglog=this.chats[activeTab].find(".imjs-msglog");msglog[0].scrollTop=msglog[0].scrollHeight}},login:function(username,password){if(!username){username=""}if(!password){password=""}if(this.username){return true}password=$.md5(password);AjaxIM.request(this.actions.login,{username:username,password:password},function(auth){if(auth.r=="logged in"){self.username=("u" in auth?auth.u:username);if(self.settings.storageMethod){self.storeKey=[self.storageBrowserKey,self.username,""].join("-")}var existing=self.cookies.get(self.settings.cookieName);self.storage();$.each(auth.f,function(){self.friends[this.u]={status:[this.s,""],group:this.g}});self._session(self.friends);self._storeFriends();$(self).trigger("loginSuccessful",[auth]);return auth}else{$(self).trigger("loginError",[auth])}return false})},logout:function(){AjaxIM.request(this.actions.logout,{},function(done){if(done){self.cookies.erase(self.settings.cookieName);self._clearSession();$(self).trigger("logoutSuccessful");return true}else{$(self).trigger("logoutError");return false}})},resume:function(){var session=this.cookies.get(this.settings.cookieName);if(session&&session.sid){this.username=session.user;this.storeKey=[this.storageBrowserKey,this.username,""].join("-");var friends=$.jStore.store(this.storeKey+"friends")||[];if(self.settings.checkResume){AjaxIM.request(this.actions.resume,{},function(response){if(response.r=="connected"){self._session(friends);self.storage()}else{var username=this.username;self._clearSession();$(self).trigger("sessionNotResumed",[username])}})}else{self._session(friends);self.storage()}}else{$(self).trigger("noSession")}},_session:function(friends){$("#imjs-friends-panel .imjs-header span").html(this.username);$("#imjs-friends").removeClass("imjs-not-connected");$.each(friends,function(friend,info){self.addFriend.apply(self,[friend,info.status,info.group])});self._storeFriends();$(self).trigger("sessionResumed",[this.username]);setTimeout(function(){self.poll()},0)},_clearSession:function(){if(self.settings.storageMethod&&self.storageReady){$.jStore.remove(self.storeKey+"chats");$.jStore.remove(self.storeKey+"friends");$.jStore.remove(self.storeKey+"activeTab")}self.chats={};$(".imjs-tab").not(".imjs-tab.imjs-default").remove();self.cookies.erase("ajaxim_session");delete self.username},form:function(element){$(element).load(this.settings.theme+"/theme.html #imjs-lr",function(){$("#imjs-lr .error").hide();if(self.username){$("#imjs-register, #imjs-login fieldset").hide();$("#imjs-logged-in").show().html($("#imjs-logged-in").html().replace("{username}",self.username))}else{$("#imjs-logged-in").hide()}$(self).bind("logoutSuccessful",function(){$("#imjs-login fieldset").slideDown();$("#imjs-register").slideDown();$("#imjs-logged-in").html($("#imjs-logged-in strong").html("{username}")).slideUp()});$("#imjs-logged-in a").click(function(){self.logout();return false});$(self).bind("loginError",function(){$("#imjs-login .error").html(AjaxIM.i18n.authInvalid).slideDown("fast");$("#imjs-login input").addClass("imjs-lr-error").blur(function(){$(this).removeClass("imjs-lr-error")})}).bind("loginSuccessful",function(){$("#imjs-login fieldset").slideUp();$("#imjs-register").slideUp();$("#imjs-logged-in").html($("#imjs-logged-in").html().replace("{username}",self.username)).slideDown()});var login=function(){self.login($("#imjs-login-username").val(),$("#imjs-login-password").val());return false};$("#imjs-login").submit(login);$("#imjs-login-submit").click(login);var regIssues=false;var regError=function(error,fields){$("#imjs-register .error").append(AjaxIM.i18n["register"+error]+" ").slideDown();$(fields).addClass("imjs-lr-error").blur(function(){$(this).removeClass("imjs-lr-error")});regIssues=true};var register=function(){$("#imjs-register .error").empty();regIssues=false;var username=$("#imjs-register-username").val();var password=$("#imjs-register-password").val();if(password.length<4){regError("PasswordLength","#imjs-register-password")}if(password!=$("#imjs-register-cpassword").val()){regError("PasswordMatch","#imjs-register-password, #imjs-register-cpassword")}if(username.length<=2||!$("#imjs-register-username").val().match(/^[A-Za-z0-9_.]+$/)){regError("UsernameLength","#imjs-register-username")}if(!regIssues){AjaxIM.request(self.actions.register,{username:username,password:password},function(response){if(response.r=="registered"){self.login(username,password)}else{if(response.r=="error"){switch(response.e){case"unknown":regError("Unknown","");break;case"invalid password":regError("PasswordLength","#imjs-register-password");break;case"invalid username":regError("UsernameLength","#imjs-register-username");break;case"username taken":regError("UsernameTaken","#imjs-register-username");break}}}},function(error){regError("Unknown","")})}return false};$("#imjs-register").submit(register);$("#imjs-register-submit").click(register)})},poll:function(){if(/^(short|long)$/.test(this.settings.pollType)){AjaxIM.request(this.actions.poll,{},function(response){if(!response.e){if(response.length){self._parseMessages(response)}setTimeout(function(){self.poll()},0)}else{switch(response.e){case"no session found":self._notConnected();break}$(self).trigger("pollFailed",[response.e])}},function(error){self._notConnected();$(self).trigger("pollFailed",["not connected"])})}else{if(this.settings.pollType=="comet"){this.comet.connect()}}},_parseMessages:function(messages){if($.isArray(messages)){$.each(messages,function(){$(self).trigger("parseMessage",[this]);switch(this.t){case"m":self.incoming(this.s,this.m);break;case"s":var status=this.m.split(":");if(this["g"]){self.addFriend(this.s,status,this.g)}self._friendUpdate(this.s,status[0],status.slice(1).join(":"));self._storeFriends();break;case"b":break;default:break}})}},incoming:function(from,message){var chatbox=this._createChatbox(from);if(!$("#imjs-bar .imjs-selected").length){chatbox.data("tab").click()}else{if(chatbox.data("tab").data("state")!="active"){this.bar.notification(chatbox.data("tab"))}}var time=this._addMessage("b",chatbox,from,message);this._storeMessage("b",chatbox,from,message,time)},addFriend:function(username,status,group){var status_name="available";$.each(this.statuses,function(key,val){if(status[0]==val){status_name=key;return false}});var group_id="imjs-group-"+$.md5(group);if(!(group_item=$("#"+group_id)).length){var group_item=$(".imjs-friend-group.imjs-default").clone().removeClass("imjs-default").attr("id",group_id).data("group",group).appendTo("#imjs-friends-list");var group_header=group_item.find(".imjs-friend-group-header");group_header.html(group_header.html().replace("{group}",group))}var user_id="imjs-friend-"+$.md5(username+group);if(!$("#"+user_id).length){var user_item=group_item.find("ul li.imjs-default").clone().removeClass("imjs-default").addClass("imjs-"+status_name).attr("id",user_id).data("friend",username).appendTo(group_item.find("ul"));if(status[0]==0){user_item.hide()}user_item.html(user_item.html().replace("{username}",username))}this.friends[username]={status:status,group:group};this._updateFriendCount();return this.friends[username]},_updateFriendCount:function(){var friendsLength=0;for(var f in this.friends){if(this.friends[f].status[0]!=0){friendsLength++}}$("#imjs-friends .imjs-tab-text span span").html(friendsLength)},_storeFriends:function(){if(this.settings.storageMethod&&this.storageReady){$.jStore.store(this.storeKey+"friends",this.friends)}},_createChatbox:function(username,no_stamp){var chatbox_id="imjs-"+$.md5(username);if(!(chatbox=$("#"+chatbox_id)).size()){var tab=this.bar.addTab(username,"#"+chatbox_id);var chatbox=tab.find(".imjs-chatbox");chatbox.attr("id",chatbox_id);chatbox.data("tab",tab);var message_log=chatbox.find(".imjs-msglog").empty();var cb_header=chatbox.find(".imjs-header");cb_header.html(cb_header.html().replace("{username}",username));if(!no_stamp){var time=this._addDateStamp(chatbox);this._storeNonMessage("datestamp",username,null,time)}this.chats[username]=chatbox;chatbox.data("username",username);this.bar._scrollers();if(username in this.friends){status=this.friends[username].status;var status_name="available";$.each(this.statuses,function(key,val){if(status[0]==val){status_name=key;return false}});tab.addClass("imjs-"+status_name)}}else{if(chatbox.data("tab").data("state")=="closed"){chatbox.find(".imjs-msglog > *").addClass("imjs-msg-old");var tab=chatbox.data("tab");if(tab.css("display")=="none"){tab.css("display","").removeClass("imjs-selected").appendTo("#imjs-bar")}if(!no_stamp){var time=this._addDateStamp(chatbox);this._storeNonMessage("datestamp",username,null,time)}if(!$("#imjs-bar .imjs-selected").length){tab.click()}else{this.bar.notification(tab)}}}return chatbox},_addDateStamp:function(chatbox,time){var message_log=$(chatbox).find(".imjs-msglog");if(!time){time=(new Date()).getTime()}var date_stamp=$(".imjs-tab.imjs-default .imjs-chatbox .imjs-msglog .imjs-date").clone();var date_stamp_time=date_stamp.find(".imjs-msg-time");if(date_stamp_time.length){date_stamp_time.html(AjaxIM.dateFormat(time,date_stamp_time.html()))}var date_stamp_date=date_stamp.find(".imjs-date-date");var formatted_date=AjaxIM.dateFormat(time,date_stamp_date.html());if(chatbox.data("lastDateStamp")!=formatted_date){if(date_stamp_date.length){date_stamp_date.html(AjaxIM.dateFormat(time,date_stamp_date.html()))}chatbox.data("lastDateStamp",formatted_date);date_stamp.appendTo(message_log)}else{}return time},_addError:function(chatbox,error,time){var message_log=$(chatbox).find(".imjs-msglog");var error_item=$(".imjs-tab.imjs-default .imjs-chatbox .imjs-msglog .imjs-error").clone();var error_item_time=error_item.find(".imjs-msg-time");if(error_item_time.length){if(!time){time=(new Date()).getTime()}error_item_time.html(AjaxIM.dateFormat(time,error_item_time.html()))}error_item.find(".imjs-error-error").html(error);error_item.appendTo(message_log);message_log[0].scrollTop=message_log[0].scrollHeight},_addMessage:function(ab,chatbox,username,message,time){var last_message=chatbox.find(".imjs-msglog > *:last-child");if(last_message.hasClass("imjs-msg-"+ab)){var message_container=(last_message.hasClass("imjs-msg-"+ab+"-container")?last_message:last_message.find(".imjs-msg-"+ab+"-container"));var single_message=$(".imjs-tab.imjs-default .imjs-chatbox .imjs-msglog .imjs-msg-"+ab+"-msg").clone().appendTo(message_container);single_message.html(single_message.html().replace("{username}",username))}else{if(!last_message.length||!last_message.hasClass("imjs-msg-"+ab)){var message_group=$(".imjs-tab.imjs-default .imjs-chatbox .imjs-msg-"+ab).clone().appendTo(chatbox.find(".imjs-msglog"));message_group.html(message_group.html().replace("{username}",username));var single_message=message_group.find(".imjs-msg-"+ab+"-msg")}}message=message.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(^|.*)\*([^*]+)\*(.*|$)/,"$1<strong>$2</strong>$3");message=message.replace(new RegExp("([A-Za-z][A-Za-z0-9+.-]{1,120}:[A-Za-z0-9/](([A-Za-z0-9$_.+!*,;/?:@&~=-])|%[A-Fa-f0-9]{2}){1,333}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*,;/?:@&~=%-]{0,1000}))?)","g"),'<a href="$1" target="_blank">$1</a>');single_message.html(single_message.html().replace("{message}",message));var msgtime=single_message.find(".imjs-msg-time");if(!time){time=new Date()}if(typeof time!="string"){time=AjaxIM.dateFormat(time,msgtime.html())}msgtime.html(time);var msglog=chatbox.find(".imjs-msglog");msglog[0].scrollTop=msglog[0].scrollHeight;return time},_storeNonMessage:function(type,username,data,time){if(this.settings.storageMethod){if(!this.chatstore){this.chatstore={}}if(!(username in this.chatstore)){this.chatstore[username]=[]}if(this.chatstore[username].length>300){this.chatstore[username].shift()}this.chatstore[username].push([type,username,encodeURIComponent(data),time]);if(this.storageReady){$.jStore.store(self.storeKey+"chats",this.chatstore)}}},_storeMessage:function(ab,chatbox,username,message,time){if(this.settings.storageMethod){if(!this.chatstore){this.chatstore={}}message=message.replace(/</g,"&lt;").replace(/>/g,"&gt;");if(!(username in this.chatstore)){this.chatstore[username]=[]}else{if(this.chatstore[username].length>300){this.chatstore[username].shift()}}this.chatstore[chatbox.data("username")].push([ab,username,encodeURIComponent(message),time]);if(this.storageReady){$.jStore.store(this.storeKey+"chats",this.chatstore)}}},_friendUpdate:function(friend,status,statusMessage){var status_name="available";$.each(this.statuses,function(key,val){if(status==val){status_name=key;return false}});if(this.chats[friend]){var tab=this.chats[friend].data("tab");var tab_class="imjs-tab";if(tab.data("state")=="active"){tab_class+=" imjs-selected"}tab_class+=" imjs-"+status_name;tab.attr("class",tab_class);var date_stamp=$(".imjs-tab.imjs-default .imjs-chatbox .imjs-msglog .imjs-date").clone();var date_stamp_time=date_stamp.find(".imjs-msg-time");if(date_stamp_time.length){date_stamp_time.html(AjaxIM.dateFormat(date_stamp_time.html()))}var date_stamp_date=date_stamp.find(".imjs-date-date").html(AjaxIM.i18n["chat"+status_name[0].toUpperCase()+status_name.slice(1)].replace(/%s/g,friend));var msglog=this.chats[friend].find(".imjs-msglog");date_stamp.appendTo(msglog);msglog[0].scrollTop=msglog[0].scrollHeight}if(this.friends[friend]){var friend_id="imjs-friend-"+$.md5(friend+this.friends[friend].group);$("#"+friend_id).attr("class","imjs-friend imjs-"+status_name);if(status==0){$("#"+friend_id+":visible").slideUp();$("#"+friend_id+":hidden").hide()}else{if(!$("#"+friend_id+":visible").length){$("#"+friend_id).slideDown()}}this.friends[friend].status=[status,statusMessage];this._updateFriendCount()}},_notConnected:function(){$("#imjs-friends").addClass("imjs-not-connected").unbind("click",this.activateTab)},send:function(to,message){if(!message){return}if(this.chats[to]){var time=self._addDateStamp(this.chats[to]);this._storeNonMessage("datestamp",to,null,time);time=this._addMessage("a",this.chats[to],this.username,message);this._storeMessage("a",this.chats[to],this.username,message,time)}$(self).trigger("sendingMessage",[to,message]);AjaxIM.request(this.actions.send,{to:to,message:message},function(result){switch(result.r){case"ok":$(self).trigger("sendMessageSuccessful",[to,message]);break;case"offline":$(self).trigger("sendMessageFailed",["offline",to,message]);break;case"error":default:if(result.e=="no session found"){self._notConnected();self._addError(self.chats[to],AjaxIM.i18n.notConnected);self._storeNonMessage("error",to,AjaxIM.i18n.notConnected,(new Date()).getTime())}$(self).trigger("sendMessageFailed",[result.e,to,message]);break}},function(error){self._notConnected();self._addError(self.chats[to],AjaxIM.i18n.notConnected);self._storeNonMessage("error",to,AjaxIM.i18n.notConnected,(new Date()).getTime());$(self).trigger("sendMessageFailed",["not connected",to,message])})},status:function(s,message){if(!this.statuses[s]){return}$("#imjs-friends").attr("class","imjs-"+s);$(self).trigger("changingStatus",[s,message]);AjaxIM.request(this.actions.status,{status:this.statuses[s],message:message},function(result){switch(result.r){case"ok":$(self).trigger("changeStatusSuccessful",[s,message]);break;case"error":default:$(self).trigger("changeStatusFailed",[result.e,s,message]);break}},function(error){$(self).trigger("changeStatusFailed",["not connected",s,message])})},statuses:{offline:0,available:1,away:2,invisible:3},bar:{initialize:function(){$(".imjs-tab").live("click",this.activateTab);$(".imjs-tab .imjs-close").live("click",this.closeTab);var self=this;$(document).click(function(e){if(e.target.id=="imjs-friends"||$(e.target).parents("#imjs-friends").length){return}if($("#imjs-friends").data("state")=="active"){self.activateTab.call($("#imjs-friends"))}});$("#imjs-friends").data("state","minimized").click(function(e){if(!$(this).hasClass("imjs-not-connected")&&e.target.id!="imjs-friends-panel"&&!$(e.target).parents("#imjs-friends-panel").length){self.activateTab.call(this)}}).mouseenter(function(){if($(this).hasClass("imjs-not-connected")){$(".imjs-tooltip").css("display","block");$(".imjs-tooltip p").html(AjaxIM.i18n.notConnectedTip);var tip_left=$(this).offset().left-$(".imjs-tooltip").outerWidth()+($(this).outerWidth()/2);var tip_top=$(this).offset().top-$(".imjs-tooltip").outerHeight(true);$(".imjs-tooltip").css({left:tip_left,top:tip_top})}}).mouseleave(function(){if($(this).hasClass("imjs-not-connected")){$(".imjs-tooltip").css("display","")}});$("#imjs-friends-panel").data("tab",$("#imjs-friends")).css("display","none")},activateTab:function(){var chatbox=$(this).find(".imjs-chatbox")||false;if($(this).data("state")!="active"){if($(this).attr("id")!="imjs-friends"){$("#imjs-bar > li").not($(this)).not("#imjs-friends").removeClass("imjs-selected").each(function(){if($(this).data("state")!="closed"){$(this).data("state","minimized");var chatbox=$(this).find(".imjs-chatbox");if(chatbox.length){chatbox.css("display","none")}}})}if(chatbox&&chatbox.css("display")=="none"){chatbox.css("display","")}var tab=$(this).addClass("imjs-selected").data("state","active");tab.find(".imjs-notification").css("display","none").data("count",0);if(self.settings.storageMethod&&self.storageReady&&chatbox&&(username=chatbox.data("username"))){$.jStore.store(self.storeKey+"activeTab",[username])}$(self).trigger("tabToggled",["activated",tab])}else{var tab=$(this).removeClass("imjs-selected").data("state","minimized");if(chatbox&&chatbox.css("display")!="none"){chatbox.css("display","none")}if(self.settings.storageMethod&&self.storageReady){$.jStore.store(self.storeKey+"activeTab",["*"])}$(self).trigger("tabToggled",["minimized",tab])}if(chatbox){if(!(input=chatbox.find(".imjs-input")).data("height")){input.data("height",input.height())}try{var msglog=chatbox.find(".imjs-msglog");msglog[0].scrollTop=msglog[0].scrollHeight}catch(e){}try{chatbox.find(".imjs-input").focus()}catch(e){}}},closeTab:function(){var tab=$(this).parents(".imjs-tab");tab.css("display","none").data("state","closed");if(self.settings.storageMethod&&self.storageReady){delete self.chatstore[tab.find(".imjs-chatbox").data("username")];if(self.storageReady){$.jStore.store(self.storeKey+"chats",self.chatstore)}}$(self).trigger("tabToggled",["closed",tab]);self.bar._scrollers();return false},addTab:function(label,action,closable){var tab=$(".imjs-tab.imjs-default").clone().insertAfter("#imjs-scroll-right");tab.removeClass("imjs-default").attr("id","imjs-tab-"+$.md5(label)).html(tab.html().replace("{label}",label)).data("state","minimized");var notification=tab.find(".imjs-notification");notification.css("display","none").data("count",0).data("default-text",notification.html()).html(notification.html().replace("{count}","0"));if(closable===false){tab.find(".imjs-close").eq(0).remove()}if(typeof action=="string"){}else{tab.find(".imjs-chatbox").remove();tab.click(action)}return tab},notification:function(tab){var notify=tab.find(".imjs-notification");var notify_count=notify.data("count")+1;notify.data("count",notify_count).html(notify.data("default-text").replace("{count}",notify_count)).css("display","")},_scrollers:function(){var needScrollers=false;$(".imjs-tab").filter(function(){return $(this).data("state")!="closed"}).css("display","");$.each(self.chats,function(username,chatbox){var tab=chatbox.data("tab");if(tab.data("state")=="closed"){return true}if(tab.position().top>$("#imjs-bar").height()){$(".imjs-scroll").css("display","");tab.css("display","none");needScrollers=true}else{tab.css("display","")}});if(!needScrollers){$(".imjs-scroll").css("display","none")}if($("#imjs-scroll-left").css("display")!="none"&&$("#imjs-scroll-left").position().top>$("#imjs-bar").height()){$("#imjs-bar li.imjs-tab:visible").slice(-1).css("display","none")}var hiddenLeft=$("#imjs-bar li.imjs-tab:visible").slice(-1).nextAll("#imjs-bar li.imjs-tab:hidden").not(".imjs-default").filter(function(){return $(this).data("state")!="closed"}).length;var hiddenRight=$("#imjs-bar li.imjs-tab:visible").eq(0).prevAll("#imjs-bar li.imjs-tab:hidden").not(".imjs-default").filter(function(){return $(this).data("state")!="closed"}).length;$("#imjs-scroll-left").html(hiddenLeft);$("#imjs-scroll-right").html(hiddenRight)}},comet:{type:"",obj:null,onbeforeunload:null,onreadystatechange:null,iframe:function(){if(/loaded|complete/i.test(this.obj.readyState)){throw new Error("IM server not available!")}},connect:function(){var self=_instance;if($.browser.opera||$.browser.msie){var iframe=$("<iframe></iframe>");with(iframe){css({position:"absolute",visibility:"visible",display:"block",left:"-10000px",top:"-10000px",width:"1px",height:"1px"});attr("src",self.actions.poll[1]);appendTo("body");bind("readystatechange",self.comet.onreadystatechange=function(){self.comet.iframe()});bind("beforeunload",self.comet.onbeforeunload=function(){self.comet.disconnect()})}self.comet.type="iframe";self.comet.obj=iframe}else{var xhr=new XMLHttpRequest;var length=1029;var code=/^\s*<script[^>]*>parent\.(.+);<\/script><br\s*\/>$/;xhr.open("get",self.actions.poll[1],true);xhr.onreadystatechange=function(){if(xhr.readyState>2){if(xhr.status==200){responseText=xhr.responseText.substring(length);length=xhr.responseText.length;if(responseText!=" "){eval(responseText.replace(code,"$1"))}}}};self.comet.type="xhr";self.comet.obj=xhr;addEventListener("beforeunload",self.comet.beforeunload=function(){self.comet.disconnect()},false);setTimeout(function(){xhr.send(null)},10)}},disconnect:function(){var self=_instance.comet;if(!this.type||!this.obj){return}if(this.type=="iframe"){detachEvent("onreadystatechange",this.onreadystatechange);detachEvent("onbeforeunload",this.onbeforeunload);this.obj.src=".";$(this.obj).remove()}else{removeEventListener("beforeunload",this.onbeforeunload,false);this.obj.onreadystatechange=function(){};this.obj.abort()}delete this.obj}}});self.bar.initialize();if(prequeue.length){$.each(prequeue,function(){var func=this[0].split(".");if(func.length>1){self[func[0]][func[1]].apply(self,this[1])}else{self[func[0]].apply(self,this[1])}})}});AjaxIM.client=null;AjaxIM.init=function(options,actions){if(!_instance){_instance=new AjaxIM(options,actions);AjaxIM.client=_instance}return _instance};AjaxIM.request=function(url,data,successFunc,failureFunc){if(typeof failureFunc!="function"){}failureFunc=function(){};$[url[0]]({url:url[1],data:data,dataType:(url[0]=="ajax"?"json":"jsonp"),type:"POST",cache:false,timeout:60000,callback:"jsonp"+(new Date()).getTime(),success:function(json,textStatus){successFunc(json)},error:function(xOptions,error){failureFunc(error)}});if(url[0]=="jsonp"&&$.browser.mozilla){$.jsonp({url:"about:",timeout:0})}};AjaxIM.incoming=function(data){if(!_instance){return false}if(data.length){_instance._parseMessages(data)}};AjaxIM.loaded=function(){if(typeof AjaxIMLoadedFunction=="function"){AjaxIMLoadedFunction();delete AjaxIMLoadedFunction}};AjaxIM.dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=new RegExp("\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b","g"),timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){val=String(val);len=len||2;while(val.length<len){val="0"+val}return val};return function(date,mask,utc){var dF=AjaxIM.dateFormat;if(arguments.length==1&&Object.prototype.toString.call(date)=="[object String]"&&!/\d/.test(date)){mask=date;date=undefined}date=date?new Date(date):new Date;if(isNaN(date)){throw SyntaxError("invalid date")}mask=String(dF.masks[mask]||mask||dF.masks["default"]);if(mask.slice(0,4)=="UTC:"){mask=mask.slice(4);utc=true}var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:AjaxIM.i18n.dayNames[D],dddd:AjaxIM.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:AjaxIM.i18n.monthNames[m],mmmm:AjaxIM.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1)})}}();AjaxIM.dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};AjaxIM.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"],chatOffline:"%s signed off.",chatAvailable:"%s became available.",chatAway:"%s went away.",notConnected:"You are currently not connected or the server is not available. Please ensure that you are signed in and try again.",notConnectedTip:"You are currently not connected.",authInvalid:"Invalid username or password.",registerPasswordLength:"Passwords must be more than 4 characters in length.",registerUsernameLength:"Usernames must be more than 2 characters in length and  contain only A-Z, a-z, 0-9, underscores (_) and periods (.).",registerPasswordMatch:"Entered passwords do not match.",registerUsernameTaken:"The chosen username is already in use; please choose another.",registerUnknown:"An unknown error occurred. Please try again."}})(jQuery,false);